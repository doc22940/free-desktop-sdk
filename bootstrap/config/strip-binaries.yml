variables:
  strip-binaries: |
    find "%{install-root}" -type f \
      '(' -perm -111 -o -name '*.so*' \
          -o -name '*.cmxs' -o -name '*.node' ')' \
      -exec sh -ec \
      'read -n4 hdr <"$1" # check for elf header
       if [ "$hdr" != "$(printf \\x7fELF)" ]; then
           exit 0
       fi
       sysroot="%{sysroot}"
       if [ -z "${sysroot}" ]; then
         sysroot="/nonexistant"
       fi
       case "${1}" in
         "%{install-root}%{debugdir}/"*|"%{install-root}%{sysroot}%{debugdir}/"*)
           exit 0
           ;;
         "%{install-root}${sysroot}/"*)
           realpath="$(realpath -s --relative-to="%{install-root}${sysroot}" "$1")"
           debugfile="%{install-root}${sysroot}%{debugdir}/${realpath}.debug"
           toolchain=%{triplet}-
           source_files=source-files-sysroot
           ;;
         *)
           realpath="$(realpath -s --relative-to="%{install-root}" "$1")"
           debugfile="%{install-root}%{debugdir}/${realpath}.debug"
           source_files=source-files
           ;;
       esac
       if "${toolchain}objdump" -j .gnu_debuglink -s "$1" &>/dev/null; then
         exit 0
       fi
       mkdir -p "$(dirname "$debugfile")"
       if [ -x "$(command -v debugedit)" ]; then
         debugedit -i --list-file=${source_files}.part --base-dir="%{build-root}" --dest-dir="%{sourcedir}/%{element-name}" "$1"
         cat "${source_files}.part" >>"${source_files}"
       fi
       mkdir -p "$(dirname "$debugfile")"
       "${toolchain}objcopy" %{objcopy-extract-args} "$1" "$debugfile"
       chmod 644 "$debugfile"
       "${toolchain}strip" %{strip-args} "$1"
       "${toolchain}objcopy" %{objcopy-link-args} "$debugfile" "$1"' - {} ';'
       sort -zu  <source-files | while read -r -d $'\0' source; do
         dst="%{install-root}%{sourcedir}/%{element-name}/${source}"
         src="%{build-root}/${source}"
         if [ -d "${src}" ]; then
           install -m0755 -d "${dst}"
           continue
         fi
         [ -f "${src}" ] || continue
         install -m0644 -D "${src}" "${dst}"
      done
      if [ -n "%{sysroot}" ]; then
        sort -zu  <source-files-sysroot | while read -r -d $'\0' source; do
          dst="%{install-root}%{sysroot}%{sourcedir}/%{element-name}/${source}"
          src="%{build-root}/${source}"
          if [ -d "${src}" ]; then
            install -m0755 -d "${dst}"
            continue
          fi
          [ -f "${src}" ] || continue
          install -m0644 -D "${src}" "${dst}"
        done
      fi
