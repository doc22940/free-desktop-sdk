name: base-sdk-bootstrap

aliases:
  flathub: https://flathub.org/

element-path: elements

variables:
  libdir: "%{prefix}/%{lib}/%{gcc_triplet}"
  indep-libdir: "%{prefix}/%{lib}"
  sysroot: /cross-installation
  cross-install: make -j1 install DESTDIR="%{install-root}%{sysroot}"
  cross-debugdir: "%{sysroot}%{libdir}/debug"
  tools-debugdir: "%{tools}/lib/debug"
  tools: /cross
  gcc_triplet: "%{target_arch}-linux-%{abi}"
  triplet: "%{gcc_arch}-unknown-linux-%{abi}"
  gcc_arch: "%{target_arch}"
  abi: "gnu"
  (?):
  - target_arch == "i586":
      gcc_arch: "i386"
  - target_arch == "arm":
      abi: "gnueabi"

  strip-binaries: |
    find "%{install-root}" -type f \
      '(' -perm -111 -o -name '*.so*' \
          -o -name '*.cmxs' -o -name '*.node' ')' \
      -exec sh -ec \
      'read -n4 hdr <"$1" # check for elf header
       if [ "$hdr" != "$(printf \\x7fELF)" ]; then
           exit 0
       fi
       case "$1" in
         "%{install-root}%{debugdir}/"*)
           exit 0
           ;;
         "%{install-root}/cross-installation%{debugdir}/"*)
           exit 0
           ;;
         "%{install-root}/cross-installation/"*)
           debugfilelink=%{debugdir}/$(realpath -s --relative-to="%{install-root}/cross-installation" "$1")"
           debugfile="%{install-root}/cross-installation${debugfilelink}"
           toolchain=%{triplet}-
           ;;
         *)
           debugfilelink="%{debugdir}/$(realpath -s --relative-to="%{install-root}" "$1")"
           debugfile="%{install-root}${debugfilelink}"
           ;;
       esac
       mkdir -p "$(dirname "$debugfile")"
       "${toolchain}objcopy" %{objcopy-extract-args} "$1" "$debugfile"
       chmod 644 "$debugfile"
       "${toolchain}strip" %{strip-args} "$1"
       "${toolchain}objcopy" %{objcopy-link-args} "$debugfilelink" "$1"' - {} ';'

environment:
  FORCE_UNSAFE_CONFIGURE: "1"
  PATH: "%{tools}/bin:/bin"
  CFLAGS: "-O2 -g -fstack-protector-strong -D_FORTIFY_SOURCE=2"
  CXXFLAGS: "-O2 -g -fstack-protector-strong -D_FORTIFY_SOURCE=2"
  LDFLAGS: "-fstack-protector-strong -Wl,-z,relro,-z,now"

plugins:
  elements:
    - plugins/elements

options:
  target_arch:
    type: arch
    description: Target architecture
    variable: target_arch
    values:
      - arm
      - aarch64
      - i586
      - x86_64

  build_arch:
    type: arch
    description: Build architecture
    variable: build_arch
    values:
      - arm
      - aarch64
      - i586
      - x86_64

